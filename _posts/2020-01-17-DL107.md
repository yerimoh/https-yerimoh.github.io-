---
title: "Deep learning: BERT 구현, 코드 설명"
date:   2020-01-17
excerpt: ""
category: [Deep Learning]
layout: post
tag:
- Deep Learning
order: 0

comments: true
---


# 목차



----
---

👀, 🤷‍♀️ , 📜    
이 아이콘들을 누르시면 코드, 개념 부가 설명을 보실 수 있습니다:)

---
----


# INRTO
이번 포스트에선 NVIDIA의 NeMo를 써서 bert를 사용해 볼 것이다

**[목표]**              
사전 트레이닝된 대규모 고성능 Transformer 기반 언어 모델흘 사용하여 NLP 작업,   
* **0) 데이터 살펴보기**: NCBI 질병 언어 자료에서 가져온 데이터세트를 사용     
* **1) pretraining:** 텍스트 분류        
* **2) fine tuning:** NER(명명된 엔터티 인식)구축   





**[읽기 위해 필요한 지식]**    
* [attention](https://yerimoh.github.io/DL19/)             
* [transformer](https://yerimoh.github.io/Lan/): 정말 무조건무조건 정독하자 이거 읽고오면 이번 포스트는 껌이다.            
* [bert](https://yerimoh.github.io/Lan2/)    

**[원 논문]**          
[Attention is All You Need](https://arxiv.org/abs/1706.03762)              
[bert](https://arxiv.org/pdf/1810.04805.pdf)              
  
      



---
---

# **0) 데이터 살펴보기**
**[Corpus Annotated Data]**     
14명의 주석자가 어노테이션을 진행 한 단 793개의 PubMed Abstract      
명확하게 정의된 규칙을 사용해 Abstract 텍스트에 삽입되는 HTML 스타일 태그의 형식을 지님     

**다른 데이터에 적용을해보려면 그 데이터를 로드하면 된다**

-----



## 1) pretraining: 테스트 분류 데이터 세트
텍스트의 내용에 따라 텍스트를 분류하는 것이 목표이다.       
텍스트 분류 적용 예    
* 감정분석: 2개의 클래스      
* 주제 레이블 지정: 여러클래스     
필요한 데이터 세트를 이해하려면 하고싶은 질문이 뭔지부터 정해야한다.        



<details>
<summary>📜 감정분석 </summary>
<div markdown="1">

이진분류임(2개의 클래스)    
* 감정이 긍정적인가      
* 감정이 부정적인가 
  
즉 각 문장에 이 두가지 중 하나로 레이블을 지정해야한다.        
  
➡ 기업들이 온라인 대화와 피드백에서 제품, 브랜드 또는 서비스에 대한 고객의 감정을 파악하는 데 널리 사용됨    
  
</div>
</details> 

<details>
<summary>📜 주제레이블 지정 </summary>
<div markdown="1">

다중분류임(Multi-Class Analysis)    
* ex) 주어진 의학 질병 Abstract은 암 또는 신경계 질환, 아니면 그 밖의 다른 질병에 대한 Abstract인가?    

데이터 형식     
* ```.tsv```형식으로 저장: ```.csv``` 쉼표로 구분된 형식과 유사하지만 ~~쉼표~~ 대신 **탭**을 사용해 열을 구분    
  
  
  
</div>
</details> 




**[데이터 가져오기]**
먼저 [pandas](https://yerimoh.github.io/PD/)를 이용하여 데이터를 가져와 보자    

<details>
<summary>👀 데이터 확인 코드 보기</summary>
<div markdown="1">

쓰고싶은 데이터를 각자 가져오면 된다
```python
import pandas as pd
pd.options.display.max_colwidth = None
```
  
```python
train_df = pd.read_csv(TC_DATA_DIR + 'train.tsv', sep='\t')
train_df.head()
```


결과
```
Identification of APC2, a homologue of the adenomatous polyposis coli tumour suppressor . The adenomatous polyposis coli ( APC ) tumour-suppressor protein controls the Wnt signalling pathway by forming a complex with glycogen synthase kinase 3beta ( GSK-3beta ) , axin / conductin and betacatenin . Complex formation induces the rapid degradation of betacatenin . In colon carcinoma cells , loss of APC leads to the accumulation of betacatenin in the nucleus , where it binds to and activates the Tcf-4 transcription factor ( reviewed in [ 1 ] [ 2 ] ) . Here , we report the identification and genomic structure of APC homologues . Mammalian APC2 , which closely resembles APC in overall domain structure , was functionally analyzed and shown to contain two SAMP domains , both of which are required for binding to conductin . Like APC , APC2 regulates the formation of active betacatenin-Tcf complexes , as demonstrated using transient transcriptional activation assays in APC - / - colon carcinoma cells . Human APC2 maps to chromosome 19p13 . 3 . APC and APC2 may therefore have comparable functions in development and cancer .	0

...
  
```
  
  
</div>
</details>



-----


## 2) fine tuning: NER 데이터 세트
NER 작업에서는 새로운 질문을 할 것입니다.    
➡ 의학 Abstract의 주어진 문장에서 **어떤 질병**이 언급되었나요?     
➡ 이 경우 데이터 입력은 Abstract의 문장이며 레이블은 명명된 질병 엔터티의 위치이다.     

데이터세트에 대해 제공된 정보를 살펴보자.   


<details>
<summary>👀 데이터 확인 코드 보기</summary>
<div markdown="1">

쓰고싶은 데이터를 각자 가져오면 된다
  
```python
NER_DATA_DIR = '/dli/task/data/NCBI_ner-3/'
!ls -lh $NER_DATA_DIR
```
  
결과
```
total 4.0M
-rw-r--r-- 1 702112 10513  181K Jul 13  2020 dev.tsv
-rw-r--r-- 1 702112 10513     5 Jul 13  2020 label_ids.csv
-rw-r--r-- 1 702112 10513    52 Jul 13  2020 label_stats.tsv
-rw-r--r-- 1 702112 10513   48K Jul 13  2020 labels_dev.txt
-rw-r--r-- 1 702112 10513   49K Jul 13  2020 labels_test.txt
-rw-r--r-- 1 702112 10513  271K Jul 13  2020 labels_train.txt
-rw-r--r-- 1 702112 10513  185K Jul 13  2020 test.tsv
-rw-r--r-- 1 702112 10513  135K Jul 13  2020 text_dev.txt
-rw-r--r-- 1 702112 10513  138K Jul 13  2020 text_test.txt
-rw-r--r-- 1 702112 10513  758K Jul 13  2020 text_train.txt
-rw-r--r-- 1 702112 10513 1023K Jul 13  2020 train.tsv
-rw-r--r-- 1 702112 10513  1.2M Jul 13  2020 train_dev.tsv
```
 

NER 작업을 수행하려면 두 개의 파일이 필요함    
➡ 텍스트 문장과 레이블 파일. 다음 2개의 셀을 실행하여 이 두 파일의 샘플을 확인함    
```python
!head $NER_DATA_DIR/text_train.txt
```
  
결과
```

Identification of APC2 , a homologue of the adenomatous polyposis coli tumour suppressor . 
The adenomatous polyposis coli ( APC ) tumour - suppressor protein controls the Wnt signalling pathway by forming a complex with glycogen synthase kinase 3beta ( GSK - 3beta ) , axin / conductin and betacatenin . 
Complex formation induces the rapid degradation of betacatenin . 
In colon carcinoma cells , loss of APC leads to the accumulation of betacatenin in the nucleus , where it binds to and activates the Tcf - 4 transcription factor ( reviewed in [ 1 ] [ 2 ] ) . 
Here , we report the identification and genomic structure of APC homologues . 
Mammalian APC2 , which closely resembles APC in overall domain structure , was functionally analyzed and shown to contain two SAMP domains , both of which are required for binding to conductin . 
Like APC , APC2 regulates the formation of active betacatenin - Tcf complexes , as demonstrated using transient transcriptional activation assays in APC - / - colon carcinoma cells . 
Human APC2 maps to chromosome 19p13 . 
3 . 
APC and APC2 may therefore have comparable functions in development and cancer . 
```

  
</div>
</details>


**[IOB 태그 지정]**    
Abstract이 문장들로 나뉘어진 것을 볼 수 있습니다. 그런 다음 각 문장이 코퍼스의 원래 HTML 스타일 태그에 해당하는 레이블이 있는 단어로 추가로 구문 분석된다     
* IOB: Inside, Outside, Beginning     
이해가 안된다면 넘어가도 괜찮다

NER 트레이닝 데이터는 단어를 I, O, B(inside, outside, beginning)와 같은 태그에 매핑하여 엔터티를 식별하는 것이다.     

<details>
<summary>👀 데이터 확인 코드 보기</summary>
<div markdown="1">

 
  
```python
!head $NER_DATA_DIR/labels_train.txt
```
결과
```
O O O O O O O O B I I I O O 
O B I I I I I I O O O O O O O O O O O O O O O O O O O O O O O O O O O O O 
O O O O O O O O O 
O B I O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O 
O O O O O O O O O O O O O 
O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O O 
O O O O O O O O O O O O O O O O O O O O O O O O O O B I O O 
O O O O O O O 
O O 
O O O O O O O O O O O B O 
```


즉 이 태그들이 이런식으로 지정되어있다.
  

```
Identification of APC2 , a homologue of the adenomatous polyposis coli tumour suppressor .
O              O  O    O O O         O  O   B           I         I    I      O          O  
```
  
그러므로 원래 코퍼스 태그로 재 호출하면,    

```html
Identification of APC2, a homologue of the <category="Modifier">adenomatous polyposis coli tumour</category> suppressor .
``

  
</div>
</details>


----
------

# **1) pretraining: 텍스트 분류 구축**             
**[목표]**        
의학적 질병 abstract를 각각 암 질환, 신경 질환 및 장애, 그리고 기타의 세가지 분류 중 하나로 분류할 수 있는 애플리케이션을 구축하는 것.       


## NeMo 개요
NeMo는 대화형 AI 애플리케이션을 구축하기 위한 오플 소스 툴킷입니다.    
* NeMo는 Neural Modules을 중심으로 구축되어, **유형화된 입력**을 받아 **유형화된 아웃풋**으로 생성하는 뉴럴 네트워크의 개념 블록(conceptual blocks)으로 되어 있음.      
* 모듈: 레이어, 인코더, 디코더, 언어 모델, 손실 함수, 또는 결합된 액티베이션 방법    

NeMo는 이러한 빌딩 블록들을 **결합**하고 **재사용하기 쉽게 만들어주면**서 Neural Type 시스템을 통해 **의미론적 정확도 검사**(a level of semantic correctness checking)를 제공    


[NeMo 딥러닝 프레임워크]
뉴럴 네트워크 트레이닝을 위한 PyTorch 코드를 정리한 Pytorch wrapper인 Pytorch Lightning에 기반되어 있습니다. PyTorch Lightning은 쉽고 고성능의 멀티-GPU/멀티-노트 혼합 정밀 트레이닝(mixed precision training) 옵션을 제공합니다. 딥 뉴럴 네트워크 프로젝트 또는 **experiment(실험)**을 만들려면, 두 가지 주요 구성 요소가 필요합니다.:

LightningModule(라이트닝모듈)
Trainer(트레이너)
LightningModule(라이트닝모듈) 은 트레이닝, 유효성 검사, 테스트를 위한 연산, 옵티마이저, 루프 문으로 PyTorch 코드로 구성하는데 활용합니다. 이 추상화 기법은 딥 러닝 실험을 이해하고 재생산하기 더 쉽게 만들어 줍니다.

그리고 Trainer(트레이너) 는 LightningModule(라이트닝모듈)을 가지고 올 수 있으며 딥 러닝 트레이닝을 위해 필요한 모든 것을 자동화할 수 있습니다.

2.1.1 NeMo 모델
NeMo 모델은 트레이닝과 재현성을 위한 모든 지원 인프라를 갖춘 LightningModules(라이트닝모듈) 입니다. 여기에는 딥 러닝 모델 아키텍처, 데이터 사전 처리, 옵티마이저, 체크포인트와 실험 로깅 기능이 포함됩니다. NeMo 모델은 라이트닝모듈과 같이 PyTorch 모듈이며 더 넓은 PyTorch 생태계와 완벽하게 호환됩니다. 어떤 NeMo model도 모든 PyTorch 워크플로우에 연결할 수 있습니다.

모든 NeMo 모델의 예제 Configuration 파일과 트레이닝 스크립트는 다음 NVIDIA NeMo GitHub Repo에서 찾을 수 있습니다.

이번 수업을 위해서, NGC NeMo container에 기반한 실습 환경에 포함된 로컬 repo 복사본를 이용할 계획이며 NLP 모델에 집중합니다. 다음 셀을 실행하여 examples/nlp 디렉토리에 있는 NeMo 모델 트리를 확인합니다.

!tree nemo/examples/nlp -L 2
클래식한 NLP 태스크를 다루는 여러 모델이 있습니다. 이번 노트북에서는 텍스트 분류에 대해 초점을 맞출 예정이며, 다음에 있을 명명된 엔티티 인식(NER) 노트북에서는 토큰 분류 을 중심으로 실습을 진행할 예정입니다.

각각의 NeMo 모델 타입은 환경 구성 파일에 대한 conf 폴더와 하나 이상의 Python 트레이닝 스크립트 파일을 포함하고 있습니다.

텍스트 분류에 대한 자세한 내용을 보려면 다음 셀을 실행하십시오:

TC_DIR = "/dli/task/nemo/examples/nlp/text_classification"
!tree $TC_DIR
환경 파일 text_classification_config.yaml에서는 파일 위치, 사전 훈련된 모델, 하이퍼 파라미터와 같은 모델, 트레이닝, 실험 관리를 위한 세부 정보를 지정합니다.

Python 스크립트 text_classification_with_bert.py는 환경 파일에서 정의된 텍스트 분류 실험을 진행하는데 필요한 모든 것을 캡슐화하고 있습니다. Configuration(환경 설정) 관리를 위해 페이스북의 Hydra 도구를 사용하여 커맨드 라인 옵션을 사용하여 구성 값을 재정의할 수 있도록 하여 스크립트와 함께 전체 실험을 진행할수 있도록 합니다!

실험을 신속하게 구축하는 비결은 기본 구성 파일에 포함된 내용과 여러분의 프로젝트를 위해 변경해야하는 내용을 정확히 이해하는 것입니다.






























