---
title: "[014] [INDEX] Computer Network: TCP(2) TCP 프로토콜"
date:   2021-02-22
excerpt: ""
category: [CS basic]
layout: post
tag:
- CS basic
order: 0

comments: true
---


# 목차

02 TCP 프로토콜
TCP Transmission Control Protocol 는 IP 프로토콜 위에서 연결형 서비스를 지원하는 전송 계층 프로토콜로, 인터넷 환경에서 기본으로 사용한다. TCP에서 제공하는 주요 기능은 다음과 같다.
• 연결형 서비스를 제공한다.
• 전이중 Full Duplex 방식의 양방향 가상 회선을 제공한다.
• 신뢰성 있는 데이터 전송을 보장한다.
[그림 9-7]은 인터넷 환경에서 사용하는 TCP/IP 프로토콜의 계층적인 구조를 보여준다. 인터넷에서 네트워크 계층의 기능을 제공하는 프로토콜은 IP이며, IP 프로토콜 위에서 실행되는 전송 계층 프로토콜은 서비스의 유형에 따라 두 종류로 구분한다. TCP는 연결형 서비스를 지원하는 프로토콜이고, UDP는 비연결형 서비스를 지원하는 프로토콜이다. 전송 계층 프로 토콜은 운영 체제의 내부 기능으로 구현된다. 따라서 이 서비스를 사용하려면 상위 계층에서 시스템 콜이라는 프로그램 호출 방식을 이용해야 한다.

전송 계층 프로토콜인 TCP와 UDP 위에는 세션 계층, 표현 계층, 응용 계층의 기능을 지원하는 다양한 응용 프로그램이 존재한다. 응용 프로그램이 해당 응용 환경에 적합한 기능을 지원 하기 위해 연결형 서비스가 필요한지, 비연결형 서비스가 필요한지를 판단해 TCP와 UDP를 선택한다. TCP나 UDP를 선택할 때는 단순히 신뢰성이나 연결 유무의 차이뿐 아니라, 이러한 차이가 응용 프로그램의 구축에 어떤 영향을 끼치는지 이해해야 한다.
응용 프로그램의 종류는 아주 다양하다. 파일 전송 기능, 메일 송수신 기능 등은 일반 사용자가 가장 많이 이용하는 인터넷 서비스이다. 호스트의 이름과 주소를 변환하는 네임 서버 기능은 사용자가 의식하지 못하지만 중요한 인터넷 서비스 중 하나이다. 이에 대한 내용은 뒤에서 자세히 다룬다. NFS Network File System 는 원격 분산 파일 시스템 기능을 지원하는 것으로, 호스트 사이의 파일 공유와 유사한 기능을 제공한다.
네트워크 계층 아래에는 데이터 링크 계층을 지원하는 X.25, 이더넷, 위성 통신 등 다양한 종류의 네트워크 인터페이스가 존재한다.
TCP는 데이터를 세그먼트 Segment 라는 블록 단위로 분할해 전송한다. 전송되는 블록의 크기는 네트워크 부하 정도, 윈도우 크기 등의 영향을 받으며, 가변 크기를 지원한다. TCP는 세그먼 트를 하나의 단위로 간주하여 순서 번호를 관리하지 않는다. 대신 세그먼트에 실려 전송되는 데이터의 바이트 개수를 순서 번호에 반영한다.
1 TCP 헤더 구조
TCP의 세그먼트는 [그림 9-8]과 같은 헤더 구조로 시작하고, 전송 데이터가 뒤따른다. 그림 상단의 숫자는 비트 수이다.
마지막 줄의 Options와 Padding은 생략할 수 있으므로 TCP 헤더의 최소 크기는 20바이트 이다. Options 필드는 다양한 종류의 부가 정보를 전달하는 데 사용하며, 최대 40바이트의 크기를 지원한다. Padding 필드는 헤더의 크기를 4바이트 단위로 맞추려고 사용한다.

1.1 TCP 헤더의 필드
TCP 헤더 TCP Header 는 중간에 위치한 여덟 개의 플래그 비트를 비롯해 제법 많은 필드를 사용 하므로 데이터의 전송 과정이 UDP보다 복잡하다. TCP 헤더에서 정의된 필드의 의미와 용도는 다음과 같다.
• Source Port/Destination Port(송신 포트/수신 포트) : TCP로 연결되는 가상 회선 양단의 송수신 프로세스에 할당된 네트워크 포트 주소이다. 인터넷 환경에서는 통신을 원하는 프로세 스가 실행되는 호스트 주소와 함께, 호스트 내부에서 다른 프로세스와 구분할 수 있는 프로세스의 고유 주소가 필요하다. 호스트 주소는 IP 프로토콜에서 정의된 호스트의 IP 주소를 사용한 다. 프로세스에 할당되는 네트워크 자원을 포트 Port 라 하는데, 포트를 구분하기 위한 주소가 포트 번호이다. Source Port는 송신 프로세스의 포트 번호이고, Destination Port는 수신 프로 세스의 포트 번호이다. 참고로, 포트 번호는 TCP와 UDP가 별도의 주소 공간을 갖기 때문에 같은 번호를 독립적으로 사용할 수 있다.
• Sequence Number(순서 번호) : 송신 프로세스가 지정하는 순서 번호이다. 세그먼트 전송 과정에서 전송되는 바이트의 수를 기준으로 증가한다. 즉, TCP에서는 전송 데이터의 각 바이트
마다 순서 번호가 존재한다. 크기가 32비트인 필드로 표시할 수 있고, 최대 범위가 2 32 개로 충분히 크므로 순서 번호가 중복될 염려는 없다. 송신 프로세스가 최초 데이터를 전송할 때는 임의의 순서 번호를 선택해 전송한다. 이는 전송 연결이 예기치 않은 이유로 끊겼을 때 순서 번호가 혼선되는 것을 방지하기 위함이다.
• Acknowledgement Number(응답 번호) : 수신 프로세스가 제대로 수신한 바이트의 수를 응답하기 위해 사용한다. 필드 값은 ACK 플래그 비트가 지정된 경우에만 유효하며, 다음에 수신을 기대하는 데이터의 순서 번호를 표시한다. ACK 응답을 받은 송신 프로세스는 Acknowledgement Number-1까지의 모든 데이터가 올바로 전송되었음을 확인할 수 있다.
연결 설정이나 연결 해제처럼 데이터 세그먼트가 없는 경우에도 순서 번호가 1씩 증가한다는 점에 주의한다.
• Data Offset(데이터 옵셋) : TCP 세그먼트가 시작되는 위치를 기준으로 데이터의 시작 위치를 나타내므로 TCP 헤더의 크기가 된다. 32비트 워드 단위로 표시된다.
• Reserved(예약) : 예약 필드이다.
• Window(윈도우) : 슬라이딩 윈도우 프로토콜에서 수신 윈도우의 버퍼 크기를 지정하려고 사용하며, 수신 프로세스가 수신할 수 있는 바이트의 수를 표시한다. 수신 프로세스의 버퍼 용량 초과 등으로 인해 데이터를 더 이상 수신할 수 없으면 Window 필드 값을 0으로 지정한다. 이경우에 송신 프로세스는 데이터를 더 전송하면 안 된다.
• Checksum(체크섬) : TCP 세그먼트에 포함되는 프로토콜 헤더와 데이터 모두에 대한 변형 오류를 검출하려고 사용한다. IP 프로토콜에서 사용하는 오류 검출 알고리즘을 사용한다.
• Urgent Pointer(긴급 포인터) : 긴급 데이터를 처리하기 위한 것으로, URG 플래그 비트가 지정된 경우에 유효하다. 이 필드를 사용해 송신 프로세스가 긴급히 처리하려는 데이터를 전송할수 있다. 예를 들어, Sequence Number =2,000, Urgent Pointer =100으로 지정한 패킷을 전송하면 순서 번호 2,000~2,099번의 데이터는 긴급 데이터로 전송되고, 2,100번 이후는 다시 정상 데이터로 전송된다.
1.2 TCP 헤더의 플래그 비트
TCP 헤더에는 플래그 비트가 8개 정의되어 있는데, 처음 2개 비트는 혼잡 제어 용도로 사용 된다. 나머지 6개 필드는 값이 1이면 다음과 같은 의미를 갖는다.

• URG : Urgent Pointer 필드가 유효한지를 나타낸다. 이 기능은 수신 프로세스의 응용 계층에 긴급 데이터가 도착했음을 알리는 것으로, 데이터가 응용 계층에 전달되기 전에 긴급 데이터가 왔음을 미리 알려주어 대비할 수 있게 한다. 수신 프로세스는 Urgent Pointer 값을 읽어보고 얼마나 많은 긴급 데이터가 오는지 알 수 있다.
• ACK : Acknowledgment Number 필드가 유효한지를 나타낸다. 정상적인 피기배킹 방식의 양방향 통신 환경에서, 양단 프로세스가 쉬지 않고 데이터를 전송한다고 가정하면 최초 연결 설정 과정에서 전송되는 첫 번째 세그먼트를 제외한 모든 세그먼트의 ACK 비트가 1로 지정된다.
• PSH : 현재 세그먼트에 포함된 데이터를 상위 계층에 즉시 전달하도록 지시할 때 사용 한다. 수신 프로세스로부터 PSH 세그먼트에 대한 응답 프레임이 도착하면, 프레임의 Acknowledgement Number 필드에 표시한 숫자까지의 모든 데이터가 상대 프로세스의 상위 계층에 전달되었음을 의미한다. 또한 수신 프로세스의 TCP 계층에 버퍼링된 데이터를 즉시 상위 계층에 전송함으로써 전송 지연이 감소되는 효과를 얻을 수 있다.
• RST : 연결의 리셋이나 유효하지 않은 세그먼트에 대한 응답용으로 사용한다. 송신 프로세스가 전송을 마쳤으나 수신 프로세스에 아직 도착하지 못한 세그먼트, 혹은 수신 프로세스가 아직 긍정 응답하지 않은 세그먼트는 연결이 재설정되었을 때 재전송되어야 한다.
• SYN : 연결 설정 요구를 의미하는 플래그 비트이므로 가상 회선 연결을 설정하는 과정에서 사용한다.
• FIN : 한쪽 프로세스에서 더는 전송할 데이터가 없어 연결을 종료하고 싶다는 의사 표시를 상대방에게 알리려고 사용한다. 현재 전송 과정에 있는 데이터는 계속 처리할 수 있으며, 상대편 프로세스의 데이터 전송에 장애가 발생하지 않는다. 따라서 연결 해제는 양쪽 프로세스 모두가 FIN 플래그를 전송해야 완료된다.
1.3 혼잡 제어
최근에 TCP에 추가된 ECN Explicit Congestion Notification 기능은 라우터가 송신 프로세스에 명시적으로 혼잡 발생을 알려주어 송신 프로세스 스스로 트래픽을 완화하는 기술이다. TCP는 ECN 기능을 지원하기 위해 [그림 9-8]의 CWR 필드와 ECE 필드를 정의한다.
• CWR Congestion Window Reduced : ECE 비트를 수신한 송신 프로세스가 전송 윈도우 크기를 줄였 음을 통지하는 것이 목적이며, 더 이상의 ECE를 전송하지 말라는 의미이다.
• ECE Explicit Congestion Notification Echo : ECN-Echo로도 약칭되며, 네트워크 트래픽이 많아질 때라우터가 송신 프로세스에 명시적으로 혼잡을 알리려고 사용한다. 주의할 점은 송신 프로세스에 직접 전달하지 않고, IP 헤더의 ECN 필드에 CE 값을 지정하여 간접적으로 수신 프로세스에 알려준 후에 수신 프로세스의 중개 Echo 를 거쳐 송신 프로세스에 통지된다는 점이다. ECE를 수신한 송신 프로세스는 네트워크 부하를 줄이기 위해 전송 윈도우 크기를 줄인다. 라우터가 IP 프로토콜을 이용하여 수신 프로세스의 중개를 통해 간접적으로 통지하는 이유는 라우터가 TCP 프로토콜을 지원하지 않기 때문이다.
1.4 캡슐화
[그림 9-9]는 TCP 세그먼트가 상하 계층의 데이터 단위와 어떤 관계에 있는지 설명한다. 상위 계층에서 내려온 전송 데이터는 [그림 9-8]의 TCP 헤더 뒤에 추가되어 TCP 세그먼트를 구성한다. TCP 세그먼트는 다시 IP 프로토콜로 보내지고, IP 헤더에 캡슐화되어 데이터 링크 계층으로 보내진다.
계층 5 프로토콜의 데이터
TCP 헤더
I P 헤더
그림 9-9 TCP 세그먼트의 캡슐화
2 포트 번호
포트 Port 번호는 TCP와 UDP가 상위 계층에 제공하는 주소 표현 방식이다. 유닉스 환경에서는 소켓으로 포트를 구현하므로, TCP/UDP 프로토콜을 사용하려면 소켓 시스템 콜의 인터페 이스를 알아야 한다. 소켓 Socket 시스템 콜을 이용해 TCP 연결 설정이 되면 통신 양단의 프로 세스가 사용하는 고유 주소는 해당 호스트의 IP 주소와 호스트 내부의 포트 번호가 조합된 형태이다.

클라이언트-서버의 연동은 서버가 먼저 실행되고, 클라이언트가 서버와 연결을 시도하는 방식으로 이루어진다. 이때 연결을 원하는 서버와 접속하려면 서버의 IP 주소와 포트 번호를 알아야 한다.
인터넷 환경에서 많이 사용하는 네트워크 응용 서비스의 서버 프로세스에 할당된 포트 번호를 Well-known 포트라 하는데, 전 세계 모든 컴퓨터가 동일한 포트 번호를 사용하도록 권고받고 있다. 예를 들어, [표 9-1]의 FTP, 전자 메일(SMTP), 웹 서비스(HTTP), DNS처럼 인터 넷에서 자주 사용하는 응용 서비스는 모두 고정된 포트 번호를 사용한다.
표 9-1 Well-known 포트
서비스 포트 번호
FTP(데이터 채널) 20
FTP(제어 채널) 21
Telnet(텔넷) 23
SMTP 25
DNS 53
TFTP 69
HTTP 80
rlogin 513
rsh 514
portmap 111
네트워크 서비스를 제공하는 포트 번호는 컴퓨터의 파일 시스템에 보관되므로 일반 사용자가 포트 번호를 직접 지정하는 경우는 없다. 사용자가 연결을 원하는 서버의 호스트 IP 주소만 클라이언트 프로그램에 알려주고, 포트 번호 선택은 프로그램에서 자동으로 해준다. TCP와 UDP는 별도의 포트 주소 공간을 관리하므로 동일한 포트 번호를 사용할 수 있다. 즉, 두 프로토콜에서 동일한 포트 번호를 할당해도 서로 다른 포트로 간주된다.

03 TCP 프로토콜을 이용한 데이터 전송
TCP 프로토콜은 전이중 방식의 양방향 통신을 지원하므로 가상 회선으로 연결된 두 프로세 스가 동시에 데이터를 전송할 수 있다. 따라서 전송 데이터와 응답 데이터를 함께 전송하는 피기배킹 Piggybacking 기능을 사용한다.
연결형 서비스를 제공하는 TCP에서 데이터를 전송하려면 연결 설정, 데이터 전송, 연결 해제 라는 3단계를 순차적으로 진행해야 한다.
1 연결 설정
TCP를 사용하는 프로세스가 가장 먼저 실행하는 연결 설정은 [그림 9-10]과 같은 3단계 설정 Three-Way Handshake 방식이다. 그림에서 A 프로세스가 연결 설정을 요구하고, B 프로세스가 이를 수락하는 형식이다.
먼저 A 프로세스는 TCP 헤더의 SYN 플래그를 지정한 세그먼트를 전송함으로써 연결 설정을 요구한다. 순서 번호 10번은 임의로 설정한 것이다. 연결 설정 요구를 받은 B 프로세스가 연결을 수락하려면 이에 대한 긍정 응답을 해야 한다. 이를 위해 SYN과 ACK 플래그를 지정해 연결에 대한 긍정 응답을 표시하였다. SYN 플래그가 지정한 세그먼트에는 전송 데이터가 포함되지 않지만 순서 번호는 1이 증가한다. 따라서 SYN 세그먼트의 순서 번호 10에 1을 더한 11번을 Acknowledgment Number 필드에 지정해 회신한다. Acknowledgement Number 값을 유효하게 하기 위해 ACK 플래그를 지정했으며, B 프로세스의 순서 번호 50
번은 임의로 지정하였다.
마지막 세 번째 세그먼트는 B 프로세스가 전송한 연결 수락 세그먼트가 제대로 도착했음을 알린다. [그림 9-10]은 A 프로세스가 전송할 데이터가 없을 때 처리하는 방식이고, 전송 데이터가 있으면 세 번째 세그먼트에서 바로 데이터를 전송해도 된다.

2 데이터 전송
TCP는 데이터 전송 과정에서 흐름 제어를 지원하려고 슬라이딩 윈도우 프로토콜을 사용한 다. 데이터를 수신하는 프로세스는 응답 세그먼트 헤더의 Window 필드를 이용해 윈도우 크기를 늘리거나 줄여 송신 프로세스의 전송 속도를 조절한다.
2.1 정상적인 데이터 전송
TCP의 데이터 전송은 [그림 9-11]처럼 양쪽 프로세스가 동시에 데이터를 전송할 수 있는 전이중 방식을 지원한다. [그림 9-10]의 세 번째 세그먼트를 전송하는 과정에서 데이터 전송이 이루어지지 않았는데, A 프로세스가 B 프로세스에 전송할 데이터가 있으면 세 번째 세그먼트에 데이터를 실어서 전송할 수 있다.
[그림 9-11]에서는 [그림 9-10]의 세 번째 단계에서 데이터를 전송한다고 가정했다. 즉, [그림 9-10]의 첫 번째와 두 번째 세그먼트가 전송되고, 이어서 [그림 9-11]의 세그먼트 세 개가 순차적으로 전송되는 경우를 설명하고 있다. 그림은 A 프로세스가 먼저 순서 번호 11번부터 5 바이트의 데이터를 전송하고, B 프로세스는 순서 번호 51번부터 10바이트의 데이터를 전송한 다. 순서 번호와 응답 번호의 조합은 전송되는 데이터의 양에 따라 적절히 조정되고 있다.

그림 9-11 TCP 데이터 전송
TCP의 흐름 제어는 프로토콜 헤더의 Window 필드를 사용한다. Window 필드에 지정한값 이상으로 데이터를 전송할 수 없으므로 수신 프로세스는 자신의 처리 능력에 맞는 값으로 지정해 송신 프로세스의 전송 속도를 제어한다. 예를 들어, 송신 프로세스가 데이터를 1,000 번부터 전송한다고 가정했을 때 수신 프로세스로부터 Window = 300으로 지정된 세그먼트가 도착하면 1,299번까지의 데이터를 연속으로 전송할 수 있다. 그러나 다음 데이터는 수신 프로세스로부터 응답이 도착했을 때만 전송할 수 있다.
2.2 데이터 전송 오류
TCP 데이터를 세그먼트 Segment 라 부르며, 순서 번호와 함께 전송된다. 순서 번호는 상위 계층 에서 보낸 데이터의 바이트 수에 기초하여 부여되고, 수신 프로세스는 이 번호를 근거로 데이 터의 순서를 올바르게 정렬할 수 있다. 순서 번호가 동일한 데이터가 도착하면 중복으로 판단 하여 해당 데이터를 버리고, 중간의 순서 번호가 빠지면 데이터를 분실했다고 판단한다.
TCP는 부정 응답 기능인 NAK를 사용하지 않는다. 따라서 수신 프로세스에 도착한 데이터 세그먼트의 내용이 변형되어도 수신 프로세스가 응답을 하지 않아 데이터 분실과 동일하게 처리된다. 데이터 변형과 분실 오류가 발생하면 수신 프로세스로부터 회신을 받을 수 없으므로 송신 프로세스의 타임아웃 Timeout 기능에 의해 오류가 복구된다.

[그림 9-12]는 A 프로세스가 TCP 세그먼트 세 개를 연속으로 전송하고, 이 중 세 번째 세그 먼트에 오류가 발생했다고 가정한 경우이다.
A 프로세스 B 프로세스
(Seq=11, Data=10)
(Seq=21, Data=10)
(Seq=31, Data=10)
(Ack=31, ACK)
정상 정상 변형/분실
타임아웃
(Seq=31, Data=10) 재전송
(Ack=41, ACK)
정상
그림 9-12 전송 오류
A 프로세스가 순서 번호 11~20번, 21~30번, 31~40번인 데이터 세그먼트를 전송하고, 이들이 모두 정상적으로 수신되면 41번 응답 번호를 긍정 응답으로 회신받는다. 그러나 그림에 표시된 것처럼 마지막 31~40번 데이터 세그먼트에 오류가 발생하면 이에 대한 오류 제어를 수행해야 한다.
B 프로세스는 11~20번, 21~30번의 데이터를 올바르게 수신했으므로, 다음에 수신할 데이 터는 31번이 된다. 따라서 ACK 플래그가 지정된 응답 세그먼트의 순서 번호는 31번으로 지정된다. 한편 A 프로세스는 31~40번 데이터에 대한 긍정 응답을 받지 못했으므로 타임아웃 기능을 통해 해당 세그먼트를 재전송해야 한다.
그림에는 표시하지 않았지만 긍정 응답 세그먼트에 오류가 발생하면 수신 프로세스가 정상적 으로 수신한 세그먼트를 재전송할 수 있다. 따라서 세그먼트가 중복으로 수신될 수 있기 때문에 수신 프로세스는 순서 번호를 기준으로 중복 여부를 처리할 수 있어야 한다.

3 연결 해제
연결 해제 단계는 [그림 9-13]처럼 연결을 해제하고자 하는 쪽에서 FIN 플래그를 지정해 요구한다. 연결 해제는 양쪽 프로세스의 동의하에 진행되기 때문에 연결 해제 세그먼트를 받은 프로세스가 FIN 플래그로 응답할 때까지 연결은 계속 유지된다.
A 프로세스 B 프로세스
(Seq=16, Ack=61, ACK, FIN)
(Seq=61, Ack=17, ACK) (Seq=61, Ack=17, ACK, Data=5)
(Seq=17, Ack=66, ACK)
(Seq=66, Ack=17, ACK, FIN)
(Seq=17, Ack=67, ACK)
그림 9-13 TCP 연결 해제
FIN 플래그가 지정된 세그먼트를 수신한 프로세스는 이에 대한 응답으로 순서 번호를 1 증가 시켜서 응답 번호를 17번으로 지정한 긍정 응답 세그먼트를 회신했다. 그리고 자신이 전송할 61번 세그먼트 이후의 데이터는 계속 전송하고 있다. [그림 9-13]에서는 5바이트의 데이터를 전송한 후에 FIN 플래그를 사용해 연결 종료에 합의하고 있다.
4 혼잡 제어
ECN Explicit Congestion Notification 기능은 TCP의 혼잡 제어 기능을 지원한다. 이를 위해 TCP 헤더의 ECE, CWR 플래그와 IP 헤더의 ECN 필드가 새로 정의되었다. ECN 기능을 사용하려면 TCP 연결 설정 단계에서 ECN 기능을 사용할 것인지 여부를 협상해야 한다. 데이터 전송 단계에서는 혼잡을 인지한 라우터가 수신 프로세스에 혼잡을 통지한다. 그러면 수신 프로세

스는 다시 송신 프로세스에 혼잡을 통지함으로써 송신 프로세스가 전송하는 데이터의 양을 줄이는 방식으로 혼잡 제어가 이루어진다.
먼저 [그림 9-14]와 같이 TCP 연결 설정 단계에서 ECN 사용에 대한 동의 절차를 거쳐야 한다.
A 프로세스 B 프로세스
(a) 참여
(SYN, CWR, ECE)
(SYN, ACK, ECE)
A 프로세스 B 프로세스
(b) 비참여
(SYN, CWR, ECE)
(SYN, ACK)
그림 9-14 TCP 연결 설정(ECN)
연결 설정을 요청하는 A 프로세스에서 연결 설정 요구인 SYN 플래그와 함께 CWR, ECE 플래그를 지정하여 ECN 기능이 동작하는 연결 설정 요청을 보낸다. 요청을 받은 B 프로세스에서 ECN 기능을 사용할 의사가 있으면 (a)처럼 연결 설정 요구 응답인 SYN, ACK 플래그와 함께 ECE 플래그를 지정하여 응답한다. 만일 ECN 기능을 사용할 의사가 없으면 (b)와 같이 SYN, ACK 플래그만 지정하여 응답한다.
ECN 기능이 동작하는 TCP 연결을 사용하여 데이터를 전송하는 과정의 혼잡 제어 처리는 [그림 9-15]와 같다. 먼저 TCP 세그먼트를 전송하는 A 프로세스의 IP 프로토콜은 IP 헤더 내의 ECN 필드 값을 ECT(01 혹은 10)로 설정하여 전송한다. 그림에서 (a)로 표시된 부분이며, 전송되는 모든 데이터는 항상 이 값이 설정된 상태로 전송된다. 참고로 IP 헤더에 ECT가 설정 되었다는 의미는 TCP가 ECN 기능을 지원한다는 의미이다.

그림 9-15 ECN의 동작 원리
이후, 임의의 시점에서 네트워크에 혼잡이 발생하고, 라우터가 이를 감지한 경우가 (b)이다.
혼잡을 감지한 라우터는 IP 헤더에 ECT가 설정된 패킷들에 대해 CE를 설정하여 혼잡이 발생했음을 알린다. 이때, 라우터가 송신 프로세스인 A 프로세스에 직접 혼잡을 통지하지 않고, 수신 프로세스인 B 프로세스에 통지하는 것에 주의한다. 즉 수신 프로세스의 중개 Echo 를 거쳐 간접적으로 송신 프로세스에 혼잡을 통지한다.
이와 같이 수신 프로세스의 중개를 거쳐야 하는 이유는 TCP와 IP 프로토콜이 혼재하여 동작 하는 상황에서 네트워크 계층을 수행하는 라우터가 지니는 구조적인 한계 때문이다. 더불어, 혼잡을 인지한 라우터 다음에 위치한 라우터들이 ECN 기능을 반복적으로 수행하지 못하도록 하는 효과도 얻는다.
라우터로부터 IP 헤더의 CE 값을 받은 B 프로세스는 모든 TCP 세그먼트에 대해 TCP 헤더의 ECE 플래그를 지정하여 라우터가 감지한 혼잡을 A 프로세스에게 알려주며, 이는 (d)로 표현되었다. 혼잡을 인지한 A 프로세스는 송신 윈도우를 조절하여 전송되는 데이터의 양을 줄이 고, TCP 헤더의 CWR 플래그를 지정함으로써 혼잡에 적절한 조치를 취했음을 통지한다.

01
전송 계층의 기능
전송 계층에서는 네트워크 끝단에 위치하는 통신 주체가 중간의 논리적인 선로를 통해 데이터를 주고받는다. 이 과정에서 흐름 제어, 오류 제어, 패킷의 분할과 병합 등의 기능을 수행한다.
이를 지원하기 위하여 주소 표현, 멀티플렉싱, 연결 관리 등에 대한 고려가 이루어져야 한다.
02
연결 설정
연결 설정은 연결을 요청하는 프로세스의 연결 설정 요구인 Conn_Req와 상대편 프로세스에서 연결 수락을 의미하는 Conn_Ack의 회신으로 완료된다. 이와 같은 2단계 설정 과정은 통신 양단의 연결 설정을 위한 최소한의 단계이다. 실제 통신 환경에서는 오류 가능성 때문에 3단계 설정이 이루어지는데, 3번째 단계에서 전송할 데이터가 있으면 바로 데이터를 전송하고, 그렇지 않으면 2번째 단계에 대한 응답을 전송해야 한다.
03
TCP 프로토콜
TCP는 IP 프로토콜 위에서 연결형 서비스를 지원하는 전송 계층 프로토콜로, 인터넷 환경에서 기본으로 사용한다. TCP는 전이중 방식의 양방향 가상 회선을 제공하기 때문에 신뢰성 있는 데이터 전송을 보장한다. 전송 계층 프로토콜은 운영 체제의 내부 기능으로 구현되기 때문에 TCP 서비스를 사용하려면 상위 계층에서 시스템 콜이라는 프로그램 호출 방식을 이용해야 한다.
04
혼잡 제어
TCP 프로토콜의 ECN 기능은 혼잡을 인지한 라우터가 송신 프로세스에 명시적으로 혼잡 발생을 알려주어 송신 프로세스 스스로 트래픽을 완화하는 기술이다. 이를 위하여 TCP 헤더에 CWR 필드와 ECE 필드를 정의한다. ECE 비트는 네트워크 트래픽이 많아질 때 라우터가 송신 프로세스에 명시적으로 혼잡을 알리려고 사용하며, ECE 비트를 수신한 송신 프로세스가 전송 윈도우 크기를 줄였음을 통지하기 위한 목적으로 CWR 비트가 사용된다.

05
포트 번호
포트 번호는 TCP와 UDP가 상위 계층에 제공하는 주소 표현 방식이다. 소켓 시스템 콜을 이용해 TCP 연결 설정이 되면 통신 양단의 프로세스가 사용하는 고유 주소는 해당 호스트의 IP 주소와 호스트 내부의 포트 번호가 조합된 형태이다. 클라이언트-서버의 연동은 서버가 먼저 실행되고, 클라이언트가 서버와 연결을 시도하는 방식으로 이루어진다. 이때 연결을 원하는 서버와 접속하려면 서버의 IP 주소와 포트 번호를 알아야 한다. 인터넷 환경에서 많이 사용하는 네트워크 응용 서비스의 서버 프로세스에 할당된 포트 번호를 Well-known 포트라 한다.
06
데이터 전송
TCP는 전이중 방식의 양방향 통신을 지원하므로 가상 회선으로 연결된 두 프로세스가 동시에 데이터를 전송할 수 있다. 연결형 서비스를 제공하는 TCP에서 데이터를 전송하려면 연결 설정, 데이터 전송, 연결 해제라는 3단계를 순차적으로 진행해야 한다. 연결 설정은 3단계 설정 방식을 사용하며, 연결 해제는 양자의 합의 아래 이루어진다.
07
ECN의 동작 원리
ECN 기능은 TCP의 혼잡 제어 기능을 지원한다. 이를 위해 TCP 헤더의 ECE, CWR 플래그와 IP 헤더의 ECN 필드가 정의되었다. ECN 기능을 사용하기 위해서는 TCP 연결 설정 단계에서 ECN 기능의 사용 여부를 협상해야 한다. 데이터 전송 단계에서는 혼잡을 인지한 라우터가 수신 프로세스에 혼잡을 통지한다. 그러면 수신 프로세스는 다시 송신 프로세스에 혼잡을 통지함 으로써 송신 프로세스가 전송하는 데이터의 양을 줄이는 방식으로 혼잡 제어가 이루어진다.

쉽게 배우는 데이터 통신과 컴퓨터 네트워크 (개정판) | 박기현

[YES24 eBook]

http://www.yes24.com/24/goods/97828131
